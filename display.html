<!-- display.html -->
<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Turnering – Display</title>
  <style>
    body{
      margin:0;
      font-family: Arial, sans-serif;
      background:#111217; /* dark grey (not black) */
      color:#f4f4f6;
      overflow:hidden;
    }
    .wrap{
      max-width:2200px;
      margin:0 auto;
      padding:18px;
    }
    .head{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:16px;
      margin-bottom:10px;
    }
    .title{
      font-size:44px;
      font-weight:900;
      line-height:1.05;
      margin:0;
      letter-spacing:.2px;
    }
    .updated{
      font-size:18px;
      color:rgba(244,244,246,.68);
      font-weight:800;
      white-space:nowrap;
    }

    .stage{
      position:relative;
      width:100%;
      border-radius:16px;
      background:rgba(255,255,255,.03);
      border:2px solid rgba(214,31,38,.22);
      overflow:hidden;
    }

    .match{
      position:absolute;
      width:240px;
      pointer-events:none;
    }

    .when{
      position:absolute;
      top:-18px;
      left:8px;
      right:8px;
      font-size:14px;
      font-weight:800;
      color:rgba(244,244,246,.74);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .when.right{
      text-align:right;
    }

    .slot{
      position:absolute;
      height:58px;
      padding:0 12px;
      border-radius:16px;
      background:#2a0a0d; /* very dark red bubble */
      border:3px solid rgba(214,31,38,.45); /* red borders */
      font-size:26px;
      font-weight:900;
      line-height:1;
      display:flex;
      align-items:center;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      box-shadow:0 16px 40px rgba(0,0,0,.40);
      color:#f6f6f7;
    }
    .slot.right{
      justify-content:flex-end;
      text-align:right;
    }
    .slot.empty{
      opacity:.55;
      font-weight:800;
    }
    .slot.winPick{
      border-color:rgba(214,31,38,.98);
      box-shadow:0 0 0 5px rgba(214,31,38,.18) inset, 0 16px 40px rgba(0,0,0,.40);
      background:#1f070a;
    }

    .outDot{
      position:absolute;
      width:10px;
      height:10px;
      border-radius:50%;
      background:rgba(214,31,38,.92);
      box-shadow:0 0 0 5px rgba(214,31,38,.14);
      opacity:.62;
    }
    .outDot.strong{
      opacity:1;
      box-shadow:0 0 0 6px rgba(214,31,38,.18), 0 14px 28px rgba(0,0,0,.35);
    }

    /* Decided match: fade + grey, no red */
    .match.decided{
      opacity:.55;
    }
    .match.decided .slot{
      background:rgba(255,255,255,.06);
      border-color:rgba(210,210,220,.22);
      box-shadow:0 12px 28px rgba(0,0,0,.28);
      color:rgba(244,244,246,.72);
    }
    .match.decided .slot.winPick{
      background:rgba(255,255,255,.06);
      border-color:rgba(210,210,220,.22);
      box-shadow:0 12px 28px rgba(0,0,0,.28);
    }
    .match.decided .outDot{
      background:rgba(210,210,220,.55);
      box-shadow:0 0 0 5px rgba(210,210,220,.12);
      opacity:.75;
    }
    .match.decided .outDot.strong{
      background:rgba(210,210,220,.75);
      box-shadow:0 0 0 6px rgba(210,210,220,.14), 0 14px 28px rgba(0,0,0,.25);
      opacity:1;
    }

    .champ{
      position:absolute;
      height:78px;
      border-width:4px;
      font-size:34px;
      border-radius:18px;
    }

    @keyframes moveIn {
      0%   { transform: translateX(-28px); opacity:0; }
      100% { transform: translateX(0); opacity:1; }
    }
    @keyframes moveInR {
      0%   { transform: translateX(28px); opacity:0; }
      100% { transform: translateX(0); opacity:1; }
    }
    .moveInL{ animation: moveIn 450ms ease-out both; }
    .moveInR{ animation: moveInR 450ms ease-out both; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="head">
      <div class="title">Turnering</div>
      <div class="updated" id="updated">—</div>
    </div>

    <div id="stage" class="stage"></div>
  </div>

  <script>
    (function(){
      var CFG = {
        API_GET: "/.netlify/functions/get-bracket",
        POLL_MS: 1500,

        COL_W: 240,
        SLOT_W: 220,
        SLOT_H: 58,
        CHAMP_H: 78,

        STEP_DEFAULT: 260,

        PAD_TOP: 20,
        PAD_BOT: 20,
        PAD_SIDE: 22
      };

      var elStage = document.getElementById("stage");
      var elUpdated = document.getElementById("updated");

      var lastUpdated = null;
      var lastState = null;
      var lastBracket = null;

      function sTrim(s){
        return (s || "").replace(/^\s+|\s+$/g, "");
      }

      function esc(s){
        s = s || "";
        return s
          .replace(/&/g,"&amp;")
          .replace(/</g,"&lt;")
          .replace(/>/g,"&gt;")
          .replace(/"/g,"&quot;")
          .replace(/'/g,"&#039;");
      }

      function xhrGet(url, cb){
        var x = new XMLHttpRequest();
        x.onreadystatechange = function(){
          if (x.readyState !== 4) return;
          var ok = (x.status >= 200 && x.status < 300);
          var res = null;
          try { res = JSON.parse(x.responseText || "{}"); } catch(e){ res = {}; }
          cb(ok, res);
        };
        x.open("GET", url, true);
        x.send(null);
      }

      function blankState(){
        var i, p = [];
        for (i=0;i<16;i++) p.push("");
        return {
          players: p,
          winners: { r16:[null,null,null,null,null,null,null,null], qf:[null,null,null,null], sf:[null,null], f:[null] },
          times:   { r16:["","","","","","","",""],               qf:["","","",""],      sf:["",""],    f:[""] },
          updated_at: null
        };
      }

      function safeState(raw){
        var st = blankState();
        if (!raw) return st;

        if (raw.players && raw.players.length === 16) st.players = raw.players;

        if (raw.winners) {
          if (raw.winners.r16 && raw.winners.r16.length === 8) st.winners.r16 = raw.winners.r16;
          if (raw.winners.qf  && raw.winners.qf.length  === 4) st.winners.qf  = raw.winners.qf;
          if (raw.winners.sf  && raw.winners.sf.length  === 2) st.winners.sf  = raw.winners.sf;
          if (raw.winners.f   && raw.winners.f.length   === 1) st.winners.f   = raw.winners.f;
        }

        if (raw.times) {
          if (raw.times.r16 && raw.times.r16.length === 8) st.times.r16 = raw.times.r16;
          if (raw.times.qf  && raw.times.qf.length  === 4) st.times.qf  = raw.times.qf;
          if (raw.times.sf  && raw.times.sf.length  === 2) st.times.sf  = raw.times.sf;
          if (raw.times.f   && raw.times.f.length   === 1) st.times.f   = raw.times.f;
        }

        st.updated_at = raw.updated_at || null;
        return st;
      }

      function computeBracket(st){
        var out = {
          r16: { a:[], b:[], wn:[] },
          qf:  { a:[], b:[], wn:[] },
          sf:  { a:[], b:[], wn:[] },
          f:   { a:[], b:[], wn:[] },
          champ: ""
        };

        var i, a, b, w;

        for (i=0;i<8;i++){
          a = sTrim(st.players[i*2] || "");
          b = sTrim(st.players[i*2+1] || "");
          out.r16.a[i]=a; out.r16.b[i]=b;
          w = st.winners.r16[i];
          out.r16.wn[i] = (w===0) ? a : ((w===1) ? b : "");
        }

        for (i=0;i<4;i++){
          a = out.r16.wn[i*2] || "";
          b = out.r16.wn[i*2+1] || "";
          out.qf.a[i]=a; out.qf.b[i]=b;
          w = st.winners.qf[i];
          out.qf.wn[i] = (w===0) ? a : ((w===1) ? b : "");
        }

        for (i=0;i<2;i++){
          a = out.qf.wn[i*2] || "";
          b = out.qf.wn[i*2+1] || "";
          out.sf.a[i]=a; out.sf.b[i]=b;
          w = st.winners.sf[i];
          out.sf.wn[i] = (w===0) ? a : ((w===1) ? b : "");
        }

        a = out.sf.wn[0] || "";
        b = out.sf.wn[1] || "";
        out.f.a[0]=a; out.f.b[0]=b;
        w = st.winners.f[0];
        out.f.wn[0] = (w===0) ? a : ((w===1) ? b : "");

        out.champ = out.f.wn[0] || "";
        return out;
      }

      function computeStageHeight(){
        var wrap = document.getElementsByClassName("wrap")[0];
        var head = document.getElementsByClassName("head")[0];

        var h = window.innerHeight || 900;
        var used = 0;

        if (wrap && wrap.offsetTop) used += wrap.offsetTop;
        if (head && head.offsetHeight) used += head.offsetHeight;
        used += 26;

        var stageH = h - used;
        if (stageH < 520) stageH = 520;
        return stageH;
      }

      function seedPlayerCenters(stageH){
        var centers = [];
        var padTop = CFG.PAD_TOP;
        var padBot = CFG.PAD_BOT;
        var usable = stageH - padTop - padBot;
        if (usable < 200) usable = 200;

        var step = usable / 8;
        var j;
        for (j=0;j<8;j++){
          centers[j] = padTop + (j + 0.5) * step;
        }
        return centers;
      }

      function computeXS(stageW){
        var colW = CFG.COL_W;

        var minX = CFG.PAD_SIDE;
        var maxX = stageW - colW - CFG.PAD_SIDE;
        if (maxX < minX) {
          minX = 0;
          maxX = stageW - colW;
          if (maxX < 0) maxX = 0;
        }

        var centerX = Math.floor((minX + maxX) / 2);

        var availL = centerX - minX;
        var availR = maxX - centerX;
        if (availL < 0) availL = 0;
        if (availR < 0) availR = 0;

        var maxStep = Math.floor((availL < availR ? availL : availR) / 3);
        if (maxStep < 10) maxStep = 10;

        var step = CFG.STEP_DEFAULT;
        if (step > maxStep) step = maxStep;

        var xs = {
          left:  { r16: centerX - 3*step, qf: centerX - 2*step, sf: centerX - step },
          right: { r16: centerX + 3*step, qf: centerX + 2*step, sf: centerX + step },
          final: centerX
        };

        /* Final clamp (paranoia) */
        if (xs.left.r16 < minX) xs.left.r16 = minX;
        if (xs.right.r16 > maxX) xs.right.r16 = maxX;

        return { xs: xs, step: step };
      }

      function mkSlot(text, isWinner, isRight, animClass){
        var d = document.createElement("div");
        var cls = "slot";
        if (isRight) cls += " right";
        if (!text) cls += " empty";
        if (isWinner) cls += " winPick";
        if (animClass) cls += " " + animClass;
        d.className = cls;
        d.innerHTML = esc(text || "—");
        d.style.width = CFG.SLOT_W + "px";
        d.style.height = CFG.SLOT_H + "px";
        return d;
      }

      function mkWhen(text, isRight){
        var t = sTrim(text || "");
        if (!t) return null;
        var d = document.createElement("div");
        d.className = "when" + (isRight ? " right" : "");
        d.innerHTML = esc(t);
        return d;
      }

      function mkDot(x, y, strong){
        var d = document.createElement("div");
        d.className = "outDot" + (strong ? " strong" : "");
        d.style.left = x + "px";
        d.style.top = y + "px";
        return d;
      }

      function renderMatch(stage, x, yA, yB, nameA, nameB, winnerSide, whenText, isRight, z, animA, animB){
        var colW = CFG.COL_W;
        var slotW = CFG.SLOT_W;
        var slotH = CFG.SLOT_H;

        var decided = (winnerSide !== null);

        var yMin = (yA < yB) ? yA : yB;
        var yMax = (yA > yB) ? yA : yB;

        var matchTop = Math.floor(yMin - slotH/2);
        var matchH = Math.ceil((yMax + slotH/2) - matchTop);

        var m = document.createElement("div");
        m.className = "match" + (decided ? " decided" : "");
        m.style.left = x + "px";
        m.style.top = matchTop + "px";
        m.style.height = matchH + "px";
        m.style.width = colW + "px";
        m.style.zIndex = String(z);

        /* Hide time when decided */
        if (!decided) {
          var w = mkWhen(whenText, isRight);
          if (w) m.appendChild(w);
        }

        var slotLeft = Math.floor((colW - slotW) / 2);

        var isWinA = (!decided) ? ((winnerSide === 0) && !!nameA) : false;
        var isWinB = (!decided) ? ((winnerSide === 1) && !!nameB) : false;

        var a = mkSlot(nameA, isWinA, isRight, animA);
        var b = mkSlot(nameB, isWinB, isRight, animB);

        a.style.left = slotLeft + "px";
        b.style.left = slotLeft + "px";

        a.style.top = Math.floor((yA - slotH/2) - matchTop) + "px";
        b.style.top = Math.floor((yB - slotH/2) - matchTop) + "px";

        m.appendChild(a);
        m.appendChild(b);

        var outY = Math.floor(((yA + yB)/2) - matchTop - 5);
        var outX = isRight ? 6 : (colW - 16);
        m.appendChild(mkDot(outX, outY, (winnerSide !== null)));

        stage.appendChild(m);
      }

      function animFlag(prev, now){
        if (!now) return false;
        if (!prev) return true;
        return prev !== now;
      }

      function buildAnim(prevBr, br){
        var a = {
          qfA:[false,false,false,false], qfB:[false,false,false,false],
          sfA:[false,false], sfB:[false,false],
          fA:false, fB:false,
          champ:false
        };
        if (!prevBr) return a;

        var i;
        for (i=0;i<4;i++){
          a.qfA[i] = animFlag(prevBr.qf.a[i], br.qf.a[i]);
          a.qfB[i] = animFlag(prevBr.qf.b[i], br.qf.b[i]);
        }
        for (i=0;i<2;i++){
          a.sfA[i] = animFlag(prevBr.sf.a[i], br.sf.a[i]);
          a.sfB[i] = animFlag(prevBr.sf.b[i], br.sf.b[i]);
        }
        a.fA = animFlag(prevBr.f.a[0], br.f.a[0]);
        a.fB = animFlag(prevBr.f.b[0], br.f.b[0]);
        a.champ = animFlag(prevBr.champ, br.champ);
        return a;
      }

      function render(st, disableAnim){
        var br = computeBracket(st);
        var stageH = computeStageHeight();
        elStage.style.height = stageH + "px";

        var stageW = elStage.clientWidth;
        if (!stageW || stageW < 800) stageW = 1600;

        var X = computeXS(stageW).xs;

        var seed = seedPlayerCenters(stageH);

        var r16OutL = [];
        var r16OutR = [];
        var qfOutL = [];
        var qfOutR = [];
        var sfOutL = 0;
        var sfOutR = 0;
        var finalOut = 0;

        var i;

        for (i=0;i<4;i++){
          r16OutL[i] = (seed[i*2] + seed[i*2+1]) / 2;
          r16OutR[i] = (seed[i*2] + seed[i*2+1]) / 2;
        }
        for (i=0;i<2;i++){
          qfOutL[i] = (r16OutL[i*2] + r16OutL[i*2+1]) / 2;
          qfOutR[i] = (r16OutR[i*2] + r16OutR[i*2+1]) / 2;
        }
        sfOutL = (qfOutL[0] + qfOutL[1]) / 2;
        sfOutR = (qfOutR[0] + qfOutR[1]) / 2;
        finalOut = (sfOutL + sfOutR) / 2;

        var anim = disableAnim ? null : buildAnim(lastBracket, br);

        elStage.innerHTML = "";

        for (i=0;i<4;i++){
          renderMatch(
            elStage,
            X.left.r16,
            seed[i*2], seed[i*2+1],
            br.r16.a[i], br.r16.b[i],
            st.winners.r16[i],
            st.times && st.times.r16 ? st.times.r16[i] : "",
            false,
            10,
            null, null
          );
        }

        for (i=0;i<2;i++){
          renderMatch(
            elStage,
            X.left.qf,
            r16OutL[i*2], r16OutL[i*2+1],
            br.qf.a[i], br.qf.b[i],
            st.winners.qf[i],
            st.times && st.times.qf ? st.times.qf[i] : "",
            false,
            20,
            (anim && anim.qfA[i]) ? "moveInL" : null,
            (anim && anim.qfB[i]) ? "moveInL" : null
          );
        }

        renderMatch(
          elStage,
          X.left.sf,
          qfOutL[0], qfOutL[1],
          br.sf.a[0], br.sf.b[0],
          st.winners.sf[0],
          st.times && st.times.sf ? st.times.sf[0] : "",
          false,
          30,
          (anim && anim.sfA[0]) ? "moveInL" : null,
          (anim && anim.sfB[0]) ? "moveInL" : null
        );

        for (i=0;i<4;i++){
          renderMatch(
            elStage,
            X.right.r16,
            seed[i*2], seed[i*2+1],
            br.r16.a[i+4], br.r16.b[i+4],
            st.winners.r16[i+4],
            st.times && st.times.r16 ? st.times.r16[i+4] : "",
            true,
            10,
            null, null
          );
        }

        for (i=0;i<2;i++){
          var qfIdx = i + 2;
          renderMatch(
            elStage,
            X.right.qf,
            r16OutR[i*2], r16OutR[i*2+1],
            br.qf.a[qfIdx], br.qf.b[qfIdx],
            st.winners.qf[qfIdx],
            st.times && st.times.qf ? st.times.qf[qfIdx] : "",
            true,
            20,
            (anim && anim.qfA[qfIdx]) ? "moveInR" : null,
            (anim && anim.qfB[qfIdx]) ? "moveInR" : null
          );
        }

        renderMatch(
          elStage,
          X.right.sf,
          qfOutR[0], qfOutR[1],
          br.sf.a[1], br.sf.b[1],
          st.winners.sf[1],
          st.times && st.times.sf ? st.times.sf[1] : "",
          true,
          30,
          (anim && anim.sfA[1]) ? "moveInR" : null,
          (anim && anim.sfB[1]) ? "moveInR" : null
        );

        renderMatch(
          elStage,
          X.final,
          sfOutL, sfOutR,
          br.f.a[0], br.f.b[0],
          st.winners.f[0],
          st.times && st.times.f ? st.times.f[0] : "",
          false,
          40,
          (anim && anim.fA) ? "moveInL" : null,
          (anim && anim.fB) ? "moveInR" : null
        );

        var champ = document.createElement("div");
        champ.className = "slot champ" + (br.champ ? " winPick" : "") + (br.champ ? "" : " empty");
        if (anim && anim.champ) champ.className += " moveInL";

        champ.innerHTML = esc(br.champ || "—");
        champ.style.width = (CFG.COL_W) + "px";
        champ.style.height = CFG.CHAMP_H + "px";
        champ.style.left = X.final + "px";
        champ.style.top = Math.floor(finalOut - CFG.CHAMP_H/2) + "px";
        champ.style.zIndex = "50";
        elStage.appendChild(champ);

        elUpdated.innerHTML = st.updated_at ? ("Sist oppdatert: " + st.updated_at) : "—";

        lastBracket = br;
      }

      function tick(){
        xhrGet(CFG.API_GET, function(ok, res){
          if (!ok || !res || !res.ok) return;
          var st = safeState(res.state);

          if (st.updated_at && st.updated_at === lastUpdated) return;

          lastUpdated = st.updated_at || ("" + new Date().getTime());
          lastState = st;
          render(st, false);
        });
      }

      function onResize(){
        if (!lastState) return;
        render(lastState, true);
      }

      tick();
      setInterval(tick, CFG.POLL_MS);

      if (window.addEventListener) window.addEventListener("resize", onResize, false);
      else if (window.attachEvent) window.attachEvent("onresize", onResize);
    })();
  </script>
</body>
</html>
