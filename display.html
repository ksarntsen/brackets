<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Turnering – Display</title>
  <style>
    body{
      margin:0;
      font-family: Arial, sans-serif;
      background:#0b0b0d;
      color:#f4f4f6;
    }
    .wrap{
      max-width:1900px;
      margin:0 auto;
      padding:18px 18px 28px 18px;
    }
    .head{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:16px;
      margin-bottom:12px;
    }
    .title{
      font-size:44px;
      font-weight:900;
      line-height:1.05;
      margin:0;
      letter-spacing:.2px;
    }
    .updated{
      font-size:18px;
      color:rgba(244,244,246,.68);
      font-weight:800;
      white-space:nowrap;
    }

    /* Alignment math (fixed heights so rounds line up exactly) */
    .bracket{
      display:flex;
      gap:26px;
      align-items:flex-start;
    }
    .col{
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      position:relative;
    }

    .match{
      position:relative;
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-bottom:18px;  /* r16 step base */
      overflow:visible;
    }
    .match:last-child{ margin-bottom:0; }

    .when{
      position:absolute;
      top:-18px;
      left:0;
      font-size:14px;
      font-weight:800;
      color:rgba(244,244,246,.7);
      white-space:nowrap;
      max-width:300px;
      overflow:hidden;
      text-overflow:ellipsis;
      pointer-events:none;
    }

    .slot{
      width:270px;
      height:58px;              /* fixed for alignment */
      padding:0 12px;
      border-radius:16px;
      background:#121216;
      border:3px solid rgba(214,31,38,.35);
      font-size:26px;
      font-weight:900;
      line-height:1;
      display:flex;
      align-items:center;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      box-shadow:0 16px 40px rgba(0,0,0,.45);
      color:#f4f4f6;
    }
    .slot.empty{
      opacity:.55;
      font-weight:800;
    }
    .slot.winPick{
      border-color:rgba(214,31,38,.95);
      box-shadow:0 0 0 5px rgba(214,31,38,.18) inset, 0 16px 40px rgba(0,0,0,.45);
      background:#0b0b0d;
    }

    /* Derived spacing:
       slotH 58, inGap 10 -> matchH 126
       r16 step = matchH + 18 = 144
       qf padding-top = 72, qf step = 288, qf margin-bottom = 162
       sf padding-top = 144, sf step = 576, sf margin-bottom = 450
       f  padding-top = 288
    */
    .col.qf{ padding-top:72px; }
    .col.qf .match{ margin-bottom:162px; }
    .col.qf .match:last-child{ margin-bottom:0; }

    .col.sf{ padding-top:144px; }
    .col.sf .match{ margin-bottom:450px; }
    .col.sf .match:last-child{ margin-bottom:0; }

    .col.f{ padding-top:288px; }
    .col.f .match{ margin-bottom:0; }

    .col.win{ padding-top:288px; }

    .champ{
      width:310px;
      height:78px;
      font-size:34px;
      border-width:4px;
    }

    @keyframes moveIn {
      0%   { transform: translateX(-28px); opacity:0; }
      100% { transform: translateX(0); opacity:1; }
    }
    .moveIn{
      animation: moveIn 450ms ease-out both;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="head">
      <div class="title">Turnering</div>
      <div class="updated" id="updated">—</div>
    </div>

    <div id="bracket" class="bracket"></div>
  </div>

  <script>
    (function(){
      var API_GET = "/.netlify/functions/get-bracket";
      var elBracket = document.getElementById("bracket");
      var elUpdated = document.getElementById("updated");

      var lastUpdated = null;

      function sTrim(s){
        return (s || "").replace(/^\s+|\s+$/g, "");
      }

      function xhrGet(url, cb){
        var x = new XMLHttpRequest();
        x.onreadystatechange = function(){
          if (x.readyState !== 4) return;
          var ok = (x.status >= 200 && x.status < 300);
          var res = null;
          try { res = JSON.parse(x.responseText || "{}"); } catch(e){ res = {}; }
          cb(ok, res);
        };
        x.open("GET", url, true);
        x.send(null);
      }

      function blankState(){
        var i, p = [];
        for (i=0;i<16;i++) p.push("");
        return {
          players: p,
          winners: {
            r16: [null,null,null,null,null,null,null,null],
            qf: [null,null,null,null],
            sf: [null,null],
            f: [null]
          },
          times: {
            r16: ["","","","","","","",""],
            qf:  ["","","",""],
            sf:  ["",""],
            f:   [""]
          },
          updated_at: null
        };
      }

      function safeState(raw){
        var st = blankState();
        if (!raw) return st;

        if (raw.players && raw.players.length === 16) st.players = raw.players;

        if (raw.winners) {
          if (raw.winners.r16 && raw.winners.r16.length === 8) st.winners.r16 = raw.winners.r16;
          if (raw.winners.qf  && raw.winners.qf.length  === 4) st.winners.qf  = raw.winners.qf;
          if (raw.winners.sf  && raw.winners.sf.length  === 2) st.winners.sf  = raw.winners.sf;
          if (raw.winners.f   && raw.winners.f.length   === 1) st.winners.f   = raw.winners.f;
        }

        if (raw.times) {
          if (raw.times.r16 && raw.times.r16.length === 8) st.times.r16 = raw.times.r16;
          if (raw.times.qf  && raw.times.qf.length  === 4) st.times.qf  = raw.times.qf;
          if (raw.times.sf  && raw.times.sf.length  === 2) st.times.sf  = raw.times.sf;
          if (raw.times.f   && raw.times.f.length   === 1) st.times.f   = raw.times.f;
        }

        st.updated_at = raw.updated_at || null;
        return st;
      }

      function computeBracket(st){
        var out = {
          r16: { a:[], b:[], w:[], wn:[] },
          qf:  { a:[], b:[], w:[], wn:[] },
          sf:  { a:[], b:[], w:[], wn:[] },
          f:   { a:[], b:[], w:[], wn:[] },
          champ: ""
        };

        var i, a, b, w;

        for (i=0;i<8;i++){
          a = sTrim(st.players[i*2] || "");
          b = sTrim(st.players[i*2+1] || "");
          out.r16.a[i]=a; out.r16.b[i]=b;
          w = st.winners.r16[i];
          out.r16.w[i]=w;
          out.r16.wn[i] = (w===0) ? a : ((w===1) ? b : "");
        }

        for (i=0;i<4;i++){
          a = out.r16.wn[i*2] || "";
          b = out.r16.wn[i*2+1] || "";
          out.qf.a[i]=a; out.qf.b[i]=b;
          w = st.winners.qf[i];
          out.qf.w[i]=w;
          out.qf.wn[i] = (w===0) ? a : ((w===1) ? b : "");
        }

        for (i=0;i<2;i++){
          a = out.qf.wn[i*2] || "";
          b = out.qf.wn[i*2+1] || "";
          out.sf.a[i]=a; out.sf.b[i]=b;
          w = st.winners.sf[i];
          out.sf.w[i]=w;
          out.sf.wn[i] = (w===0) ? a : ((w===1) ? b : "");
        }

        a = out.sf.wn[0] || "";
        b = out.sf.wn[1] || "";
        out.f.a[0]=a; out.f.b[0]=b;
        w = st.winners.f[0];
        out.f.w[0]=w;
        out.f.wn[0] = (w===0) ? a : ((w===1) ? b : "");

        out.champ = out.f.wn[0] || "";
        return out;
      }

      function topmostDecidedRound(st){
        if (st.winners.f[0] !== null) return "f";
        if (st.winners.sf[0] !== null || st.winners.sf[1] !== null) return "sf";
        if (st.winners.qf[0] !== null || st.winners.qf[1] !== null || st.winners.qf[2] !== null || st.winners.qf[3] !== null) return "qf";
        if (st.winners.r16[0] !== null || st.winners.r16[1] !== null || st.winners.r16[2] !== null || st.winners.r16[3] !== null ||
            st.winners.r16[4] !== null || st.winners.r16[5] !== null || st.winners.r16[6] !== null || st.winners.r16[7] !== null) return "r16";
        return null;
      }

      function buildAnimTargets(st, br){
        var top = topmostDecidedRound(st);
        var targets = { qf:{}, sf:{}, f:{}, win:{} };
        var i, m, side;

        if (top === "r16") {
          for (i=0;i<8;i++){
            if (st.winners.r16[i] === null) continue;
            if (!br.r16.a[i] || !br.r16.b[i]) continue;
            m = Math.floor(i/2);
            side = (i % 2);
            targets.qf[m + "-" + side] = 1;
          }
        } else if (top === "qf") {
          for (i=0;i<4;i++){
            if (st.winners.qf[i] === null) continue;
            if (!br.qf.a[i] || !br.qf.b[i]) continue;
            m = Math.floor(i/2);
            side = (i % 2);
            targets.sf[m + "-" + side] = 1;
          }
        } else if (top === "sf") {
          for (i=0;i<2;i++){
            if (st.winners.sf[i] === null) continue;
            if (!br.sf.a[i] || !br.sf.b[i]) continue;
            side = (i % 2);
            targets.f["0-" + side] = 1;
          }
        } else if (top === "f") {
          if (st.winners.f[0] !== null && br.f.a[0] && br.f.b[0]) targets.win["champ"] = 1;
        }
        return targets;
      }

      function esc(s){
        s = s || "";
        return s
          .replace(/&/g,"&amp;")
          .replace(/</g,"&lt;")
          .replace(/>/g,"&gt;")
          .replace(/"/g,"&quot;")
          .replace(/'/g,"&#039;");
      }

      function mkWhen(text){
        var t = sTrim(text || "");
        if (!t) return null;
        var d = document.createElement("div");
        d.className = "when";
        d.innerHTML = esc(t);
        return d;
      }

      function mkSlot(text, isWinner, moveIn, isChamp){
        var d = document.createElement("div");
        d.className = "slot" + (isWinner ? " winPick" : "") + (moveIn ? " moveIn" : "");
        if (!text) d.className += " empty";
        if (isChamp) d.className += " champ";
        d.innerHTML = esc(text || "—");
        return d;
      }

      function mkMatch(a, b, winnerSide, moveA, moveB, whenText){
        var m = document.createElement("div");
        m.className = "match";

        var w = mkWhen(whenText);
        if (w) m.appendChild(w);

        m.appendChild(mkSlot(a, winnerSide===0 && a, moveA, false));
        m.appendChild(mkSlot(b, winnerSide===1 && b, moveB, false));
        return m;
      }

      function render(st){
        var br = computeBracket(st);
        var anim = buildAnimTargets(st, br);

        elBracket.innerHTML = "";

        var colR16 = document.createElement("div");
        colR16.className = "col r16";
        var i;

        for (i=0;i<8;i++){
          colR16.appendChild(mkMatch(
            br.r16.a[i], br.r16.b[i], st.winners.r16[i],
            false, false,
            (st.times && st.times.r16) ? st.times.r16[i] : ""
          ));
        }

        var colQF = document.createElement("div");
        colQF.className = "col qf";
        for (i=0;i<4;i++){
          colQF.appendChild(mkMatch(
            br.qf.a[i], br.qf.b[i], st.winners.qf[i],
            !!anim.qf[i+"-0"], !!anim.qf[i+"-1"],
            (st.times && st.times.qf) ? st.times.qf[i] : ""
          ));
        }

        var colSF = document.createElement("div");
        colSF.className = "col sf";
        for (i=0;i<2;i++){
          colSF.appendChild(mkMatch(
            br.sf.a[i], br.sf.b[i], st.winners.sf[i],
            !!anim.sf[i+"-0"], !!anim.sf[i+"-1"],
            (st.times && st.times.sf) ? st.times.sf[i] : ""
          ));
        }

        var colF = document.createElement("div");
        colF.className = "col f";
        colF.appendChild(mkMatch(
          br.f.a[0], br.f.b[0], st.winners.f[0],
          !!anim.f["0-0"], !!anim.f["0-1"],
          (st.times && st.times.f) ? st.times.f[0] : ""
        ));

        var colW = document.createElement("div");
        colW.className = "col win";
        colW.appendChild(mkSlot(br.champ, true, !!anim.win["champ"], true));

        elBracket.appendChild(colR16);
        elBracket.appendChild(colQF);
        elBracket.appendChild(colSF);
        elBracket.appendChild(colF);
        elBracket.appendChild(colW);

        elUpdated.innerHTML = st.updated_at ? ("Sist oppdatert: " + st.updated_at) : "—";
      }

      function tick(){
        xhrGet(API_GET, function(ok, res){
          if (!ok || !res || !res.ok) return;
          var st = safeState(res.state);
          if (st.updated_at && st.updated_at === lastUpdated) return;
          lastUpdated = st.updated_at || null;
          render(st);
        });
      }

      tick();
      setInterval(tick, 1500);
    })();
  </script>
</body>
</html>
