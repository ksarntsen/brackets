<!-- display.html -->
<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Turnering – Display</title>
  <style>
  body{
    margin:0;
    font-family: Arial, sans-serif;
    background:#111217; /* dark grey (not black) */
    color:#f4f4f6;
    overflow:hidden;
  }
  .wrap{
    max-width:2200px;
    margin:0 auto;
    padding:18px;
  }
  .head{
    display:flex;
    align-items:baseline;
    justify-content:space-between;
    gap:16px;
    margin-bottom:10px;
  }
  .title{
    font-size:44px;
    font-weight:900;
    line-height:1.05;
    margin:0;
    letter-spacing:.2px;
  }
  .updated{
    font-size:18px;
    color:rgba(244,244,246,.68);
    font-weight:800;
    white-space:nowrap;
  }

  .stage{
    position:relative;
    width:100%;
    border-radius:16px;
    background:rgba(255,255,255,.03);
    border:2px solid rgba(214,31,38,.22);
    overflow:hidden;
  }

  .match{
    position:absolute;
    pointer-events:none;
  }

  .when{
    position:absolute;
    top:-18px;
    left:8px;
    right:8px;
    font-size:14px;
    font-weight:800;
    color:rgba(244,244,246,.74);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .when.right{ text-align:right; }
  .when.center{ text-align:center; }

  /* Brighter, higher-contrast red bubbles */
  .slot{
    position:absolute;
    height:58px;
    padding:0 12px;
    border-radius:16px;
    background:linear-gradient(180deg, #5a0f16 0%, #2f0a0e 100%);
    border:3px solid rgba(255,65,72,.70);
    font-weight:900;
    line-height:1;
    display:flex;
    align-items:center;
    box-shadow:
      0 0 0 1px rgba(255,255,255,.06) inset,
      0 18px 44px rgba(0,0,0,.48);
    color:#ffffff;
  }
  .slotText{
    flex:1 1 auto;
    min-width:0; /* critical for right side flex + ellipsis + scrollWidth */
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
    display:block;
  }
  .slot.right{
    justify-content:flex-end;
    text-align:right;
  }
  .slot.empty{
    opacity:.55;
    font-weight:800;
  }
  .slot.winPick{
    border-color:rgba(255,65,72,.98);
    box-shadow:
      0 0 0 6px rgba(255,65,72,.20) inset,
      0 18px 44px rgba(0,0,0,.48);
    background:linear-gradient(180deg, #6a141c 0%, #320a0f 100%);
  }

  .outDot{
    position:absolute;
    width:10px;
    height:10px;
    border-radius:50%;
    background:rgba(255,65,72,.95);
    box-shadow:0 0 0 5px rgba(255,65,72,.16);
    opacity:.62;
  }
  .outDot.strong{
    opacity:1;
    box-shadow:0 0 0 6px rgba(255,65,72,.20), 0 14px 28px rgba(0,0,0,.35);
  }

  /* Decided match: fade + grey, no red */
  .match.decided{
    opacity:.55;
  }
  .match.decided .slot{
    background:rgba(255,255,255,.06);
    border-color:rgba(210,210,220,.22);
    box-shadow:0 12px 28px rgba(0,0,0,.28);
    color:rgba(244,244,246,.72);
  }
  .match.decided .slot.winPick{
    background:rgba(255,255,255,.06);
    border-color:rgba(210,210,220,.22);
    box-shadow:0 12px 28px rgba(0,0,0,.28);
  }
  .match.decided .outDot{
    background:rgba(210,210,220,.55);
    box-shadow:0 0 0 5px rgba(210,210,220,.12);
    opacity:.75;
  }
  .match.decided .outDot.strong{
    background:rgba(210,210,220,.75);
    box-shadow:0 0 0 6px rgba(210,210,220,.14), 0 14px 28px rgba(0,0,0,.25);
    opacity:1;
  }

  @keyframes moveIn {
    0%   { transform: translateX(-28px); opacity:0; }
    100% { transform: translateX(0); opacity:1; }
  }
  @keyframes moveInR {
    0%   { transform: translateX(28px); opacity:0; }
    100% { transform: translateX(0); opacity:1; }
  }
  .moveInL{ animation: moveIn 450ms ease-out both; }
  .moveInR{ animation: moveInR 450ms ease-out both; }
</style>

</head>
<body>
  <div class="wrap">
    <div class="head">
      <div class="title">Bordtennisturnering</div>
      <div class="updated" id="updated">—</div>
    </div>

    <div id="stage" class="stage"></div>
  </div>

  <script>
    (function(){
      var CFG = {
        API_GET: "/.netlify/functions/get-bracket",
        POLL_MS: 1500,

        /* Slightly narrower */
        COL_W: 220,
        SLOT_W: 196,
        SLOT_H: 58,

        /* Side-by-side final */
        FINAL_GAP: 26,

        /* Font fitting */
        SLOT_FS_BASE: 26,
        SLOT_FS_MIN: 16,

        STEP_DEFAULT: 250,

        PAD_TOP: 20,
        PAD_BOT: 20,
        PAD_SIDE: 22
      };

      var elStage = document.getElementById("stage");
      var elUpdated = document.getElementById("updated");

      var lastUpdated = null;
      var lastState = null;
      var lastBracket = null;

      function sTrim(s){
        return (s || "").replace(/^\s+|\s+$/g, "");
      }

      function esc(s){
        s = s || "";
        return s
          .replace(/&/g,"&amp;")
          .replace(/</g,"&lt;")
          .replace(/>/g,"&gt;")
          .replace(/"/g,"&quot;")
          .replace(/'/g,"&#039;");
      }

      function xhrGet(url, cb){
        var x = new XMLHttpRequest();
        x.onreadystatechange = function(){
          if (x.readyState !== 4) return;
          var ok = (x.status >= 200 && x.status < 300);
          var res = null;
          try { res = JSON.parse(x.responseText || "{}"); } catch(e){ res = {}; }
          cb(ok, res);
        };
        x.open("GET", url, true);
        x.send(null);
      }

      function blankState(){
        var i, p = [];
        for (i=0;i<16;i++) p.push("");
        return {
          players: p,
          winners: { r16:[null,null,null,null,null,null,null,null], qf:[null,null,null,null], sf:[null,null], f:[null] },
          times:   { r16:["","","","","","","",""],               qf:["","","",""],      sf:["",""],    f:[""] },
          updated_at: null
        };
      }

      function safeState(raw){
        var st = blankState();
        if (!raw) return st;

        if (raw.players && raw.players.length === 16) st.players = raw.players;

        if (raw.winners) {
          if (raw.winners.r16 && raw.winners.r16.length === 8) st.winners.r16 = raw.winners.r16;
          if (raw.winners.qf  && raw.winners.qf.length  === 4) st.winners.qf  = raw.winners.qf;
          if (raw.winners.sf  && raw.winners.sf.length  === 2) st.winners.sf  = raw.winners.sf;
          if (raw.winners.f   && raw.winners.f.length   === 1) st.winners.f   = raw.winners.f;
        }

        if (raw.times) {
          if (raw.times.r16 && raw.times.r16.length === 8) st.times.r16 = raw.times.r16;
          if (raw.times.qf  && raw.times.qf.length  === 4) st.times.qf  = raw.times.qf;
          if (raw.times.sf  && raw.times.sf.length  === 2) st.times.sf  = raw.times.sf;
          if (raw.times.f   && raw.times.f.length   === 1) st.times.f   = raw.times.f;
        }

        st.updated_at = raw.updated_at || null;
        return st;
      }

      function computeBracket(st){
        var out = {
          r16: { a:[], b:[], wn:[] },
          qf:  { a:[], b:[], wn:[] },
          sf:  { a:[], b:[], wn:[] },
          f:   { a:[], b:[], wn:[] }
        };

        var i, a, b, w;

        for (i=0;i<8;i++){
          a = sTrim(st.players[i*2] || "");
          b = sTrim(st.players[i*2+1] || "");
          out.r16.a[i]=a; out.r16.b[i]=b;
          w = st.winners.r16[i];
          out.r16.wn[i] = (w===0) ? a : ((w===1) ? b : "");
        }

        for (i=0;i<4;i++){
          a = out.r16.wn[i*2] || "";
          b = out.r16.wn[i*2+1] || "";
          out.qf.a[i]=a; out.qf.b[i]=b;
          w = st.winners.qf[i];
          out.qf.wn[i] = (w===0) ? a : ((w===1) ? b : "");
        }

        for (i=0;i<2;i++){
          a = out.qf.wn[i*2] || "";
          b = out.qf.wn[i*2+1] || "";
          out.sf.a[i]=a; out.sf.b[i]=b;
          w = st.winners.sf[i];
          out.sf.wn[i] = (w===0) ? a : ((w===1) ? b : "");
        }

        a = out.sf.wn[0] || "";
        b = out.sf.wn[1] || "";
        out.f.a[0]=a; out.f.b[0]=b;
        w = st.winners.f[0];
        out.f.wn[0] = (w===0) ? a : ((w===1) ? b : "");

        return out;
      }

      function computeStageHeight(){
        var wrap = document.getElementsByClassName("wrap")[0];
        var head = document.getElementsByClassName("head")[0];

        var h = window.innerHeight || 900;
        var used = 0;

        if (wrap && wrap.offsetTop) used += wrap.offsetTop;
        if (head && head.offsetHeight) used += head.offsetHeight;
        used += 26;

        var stageH = h - used;
        if (stageH < 520) stageH = 520;
        return stageH;
      }

      function seedPlayerCenters(stageH){
        var centers = [];
        var padTop = CFG.PAD_TOP;
        var padBot = CFG.PAD_BOT;
        var usable = stageH - padTop - padBot;
        if (usable < 200) usable = 200;

        var step = usable / 8;
        var j;
        for (j=0;j<8;j++){
          centers[j] = padTop + (j + 0.5) * step;
        }
        return centers;
      }

      function computeXS(stageW){
        var colW = CFG.COL_W;

        var minX = CFG.PAD_SIDE;
        var maxX = stageW - colW - CFG.PAD_SIDE;
        if (maxX < minX) {
          minX = 0;
          maxX = stageW - colW;
          if (maxX < 0) maxX = 0;
        }

        var centerX = Math.floor((minX + maxX) / 2);

        var availL = centerX - minX;
        var availR = maxX - centerX;
        if (availL < 0) availL = 0;
        if (availR < 0) availR = 0;

        var maxStep = Math.floor((availL < availR ? availL : availR) / 3);
        if (maxStep < 10) maxStep = 10;

        var step = CFG.STEP_DEFAULT;
        if (step > maxStep) step = maxStep;

        var xs = {
          left:  { r16: centerX - 3*step, qf: centerX - 2*step, sf: centerX - step },
          right: { r16: centerX + 3*step, qf: centerX + 2*step, sf: centerX + step },
          final: centerX
        };

        if (xs.left.r16 < minX) xs.left.r16 = minX;
        if (xs.right.r16 > maxX) xs.right.r16 = maxX;

        return { xs: xs, step: step };
      }

      function mkWhen(text, align){
        var t = sTrim(text || "");
        if (!t) return null;
        var d = document.createElement("div");
        var cls = "when";
        if (align === "right") cls += " right";
        if (align === "center") cls += " center";
        d.className = cls;
        d.innerHTML = esc(t);
        return d;
      }

      function mkDot(x, y, strong){
        var d = document.createElement("div");
        d.className = "outDot" + (strong ? " strong" : "");
        d.style.left = x + "px";
        d.style.top = y + "px";
        return d;
      }

      function mkSlot(text, isWinner, isRight, animClass){
        var d = document.createElement("div");
        var cls = "slot";
        if (isRight) cls += " right";
        if (!text) cls += " empty";
        if (isWinner) cls += " winPick";
        if (animClass) cls += " " + animClass;
        d.className = cls;

        var s = document.createElement("span");
        s.className = "slotText";
        s.innerHTML = esc(text || "—");
        d.appendChild(s);

        d.style.width = CFG.SLOT_W + "px";
        d.style.height = CFG.SLOT_H + "px";
        d.style.fontSize = CFG.SLOT_FS_BASE + "px";
        return d;
      }

      function fitSlotFont(el){
        if (!el) return;

        var base = CFG.SLOT_FS_BASE;
        var min = CFG.SLOT_FS_MIN;

        var span = el.getElementsByTagName("span")[0];
        if (!span) return;

        el.style.fontSize = base + "px";

        /* content width (clientWidth includes padding) */
        var w = (el.clientWidth || 0) - 24;
        if (w < 40) return;

        var fs = base;
        var sw = span.scrollWidth || 0;

        while (fs > min && sw > w){
          fs -= 1;
          el.style.fontSize = fs + "px";
          sw = span.scrollWidth || 0;
        }
      }

      function renderMatch(stage, x, yA, yB, nameA, nameB, winnerSide, whenText, isRight, z, animA, animB){
        var colW = CFG.COL_W;
        var slotW = CFG.SLOT_W;
        var slotH = CFG.SLOT_H;

        var decided = (winnerSide !== null);

        var yMin = (yA < yB) ? yA : yB;
        var yMax = (yA > yB) ? yA : yB;

        var matchTop = Math.floor(yMin - slotH/2);
        var matchH = Math.ceil((yMax + slotH/2) - matchTop);

        var m = document.createElement("div");
        m.className = "match" + (decided ? " decided" : "");
        m.style.left = x + "px";
        m.style.top = matchTop + "px";
        m.style.height = matchH + "px";
        m.style.width = colW + "px";
        m.style.zIndex = String(z);

        /* Hide time when decided */
        if (!decided) {
          var w = mkWhen(whenText, isRight ? "right" : "left");
          if (w) m.appendChild(w);
        }

        var slotLeft = Math.floor((colW - slotW) / 2);

        var isWinA = (!decided) ? ((winnerSide === 0) && !!nameA) : false;
        var isWinB = (!decided) ? ((winnerSide === 1) && !!nameB) : false;

        var a = mkSlot(nameA, isWinA, isRight, animA);
        var b = mkSlot(nameB, isWinB, isRight, animB);

        a.style.left = slotLeft + "px";
        b.style.left = slotLeft + "px";

        a.style.top = Math.floor((yA - slotH/2) - matchTop) + "px";
        b.style.top = Math.floor((yB - slotH/2) - matchTop) + "px";

        m.appendChild(a);
        m.appendChild(b);

        var outY = Math.floor(((yA + yB)/2) - matchTop - 5);
        var outX = isRight ? 6 : (colW - 16);
        m.appendChild(mkDot(outX, outY, (winnerSide !== null)));

        stage.appendChild(m);

        fitSlotFont(a);
        fitSlotFont(b);
      }

      /* Finalists side-by-side (no overlap), no champion bubble afterwards */
      function renderFinalSideBySide(stage, xCenter, y, nameL, nameR, winnerSide, whenText, z, animL, animR){
        var slotW = CFG.SLOT_W;
        var slotH = CFG.SLOT_H;
        var gap = CFG.FINAL_GAP;
        var wFinal = slotW + gap + slotW;

        var stageW = stage.clientWidth || 1600;
        var minLeft = CFG.PAD_SIDE;
        var maxLeft = stageW - wFinal - CFG.PAD_SIDE;
        if (maxLeft < minLeft) {
          minLeft = 0;
          maxLeft = stageW - wFinal;
          if (maxLeft < 0) maxLeft = 0;
        }

        var left = Math.floor(xCenter - wFinal/2);
        if (left < minLeft) left = minLeft;
        if (left > maxLeft) left = maxLeft;

        var top = Math.floor(y - slotH/2);

        var decided = (winnerSide !== null);

        var m = document.createElement("div");
        m.className = "match" + (decided ? " decided" : "");
        m.style.left = left + "px";
        m.style.top = top + "px";
        m.style.width = wFinal + "px";
        m.style.height = slotH + "px";
        m.style.zIndex = String(z);

        if (!decided) {
          var w = mkWhen(whenText, "center");
          if (w) m.appendChild(w);
        }

        var isWinL = (!decided) ? ((winnerSide === 0) && !!nameL) : false;
        var isWinR = (!decided) ? ((winnerSide === 1) && !!nameR) : false;

        var a = mkSlot(nameL, isWinL, false, animL);
        var b = mkSlot(nameR, isWinR, true, animR);

        a.style.left = "0px";
        a.style.top = "0px";
        b.style.left = (slotW + gap) + "px";
        b.style.top = "0px";

        m.appendChild(a);
        m.appendChild(b);

        m.appendChild(mkDot(Math.floor(wFinal/2 - 5), Math.floor(slotH/2 - 5), (winnerSide !== null)));

        stage.appendChild(m);

        fitSlotFont(a);
        fitSlotFont(b);
      }

      function animFlag(prev, now){
        if (!now) return false;
        if (!prev) return true;
        return prev !== now;
      }

      function buildAnim(prevBr, br){
        var a = {
          qfA:[false,false,false,false], qfB:[false,false,false,false],
          sfA:[false,false], sfB:[false,false],
          fA:false, fB:false
        };
        if (!prevBr) return a;

        var i;
        for (i=0;i<4;i++){
          a.qfA[i] = animFlag(prevBr.qf.a[i], br.qf.a[i]);
          a.qfB[i] = animFlag(prevBr.qf.b[i], br.qf.b[i]);
        }
        for (i=0;i<2;i++){
          a.sfA[i] = animFlag(prevBr.sf.a[i], br.sf.a[i]);
          a.sfB[i] = animFlag(prevBr.sf.b[i], br.sf.b[i]);
        }
        a.fA = animFlag(prevBr.f.a[0], br.f.a[0]);
        a.fB = animFlag(prevBr.f.b[0], br.f.b[0]);
        return a;
      }

      function render(st, disableAnim){
        var br = computeBracket(st);
        var stageH = computeStageHeight();
        elStage.style.height = stageH + "px";

        var stageW = elStage.clientWidth;
        if (!stageW || stageW < 800) stageW = 1600;

        var X = computeXS(stageW).xs;

        var seed = seedPlayerCenters(stageH);

        var r16OutL = [];
        var r16OutR = [];
        var qfOutL = [];
        var qfOutR = [];
        var sfOutL = 0;
        var sfOutR = 0;
        var finalOut = 0;

        var i;

        for (i=0;i<4;i++){
          r16OutL[i] = (seed[i*2] + seed[i*2+1]) / 2;
          r16OutR[i] = (seed[i*2] + seed[i*2+1]) / 2;
        }
        for (i=0;i<2;i++){
          qfOutL[i] = (r16OutL[i*2] + r16OutL[i*2+1]) / 2;
          qfOutR[i] = (r16OutR[i*2] + r16OutR[i*2+1]) / 2;
        }
        sfOutL = (qfOutL[0] + qfOutL[1]) / 2;
        sfOutR = (qfOutR[0] + qfOutR[1]) / 2;
        finalOut = (sfOutL + sfOutR) / 2;

        var anim = disableAnim ? null : buildAnim(lastBracket, br);

        elStage.innerHTML = "";

        /* Left side: r16 indices 0..3 */
        for (i=0;i<4;i++){
          renderMatch(
            elStage,
            X.left.r16,
            seed[i*2], seed[i*2+1],
            br.r16.a[i], br.r16.b[i],
            st.winners.r16[i],
            st.times && st.times.r16 ? st.times.r16[i] : "",
            false,
            10,
            null, null
          );
        }

        /* Left side: qf indices 0..1 */
        for (i=0;i<2;i++){
          renderMatch(
            elStage,
            X.left.qf,
            r16OutL[i*2], r16OutL[i*2+1],
            br.qf.a[i], br.qf.b[i],
            st.winners.qf[i],
            st.times && st.times.qf ? st.times.qf[i] : "",
            false,
            20,
            (anim && anim.qfA[i]) ? "moveInL" : null,
            (anim && anim.qfB[i]) ? "moveInL" : null
          );
        }

        /* Left side: sf index 0 */
        renderMatch(
          elStage,
          X.left.sf,
          qfOutL[0], qfOutL[1],
          br.sf.a[0], br.sf.b[0],
          st.winners.sf[0],
          st.times && st.times.sf ? st.times.sf[0] : "",
          false,
          30,
          (anim && anim.sfA[0]) ? "moveInL" : null,
          (anim && anim.sfB[0]) ? "moveInL" : null
        );

        /* Right side: r16 indices 4..7 */
        for (i=0;i<4;i++){
          renderMatch(
            elStage,
            X.right.r16,
            seed[i*2], seed[i*2+1],
            br.r16.a[i+4], br.r16.b[i+4],
            st.winners.r16[i+4],
            st.times && st.times.r16 ? st.times.r16[i+4] : "",
            true,
            10,
            null, null
          );
        }

        /* Right side: qf indices 2..3 */
        for (i=0;i<2;i++){
          var qfIdx = i + 2;
          renderMatch(
            elStage,
            X.right.qf,
            r16OutR[i*2], r16OutR[i*2+1],
            br.qf.a[qfIdx], br.qf.b[qfIdx],
            st.winners.qf[qfIdx],
            st.times && st.times.qf ? st.times.qf[qfIdx] : "",
            true,
            20,
            (anim && anim.qfA[qfIdx]) ? "moveInR" : null,
            (anim && anim.qfB[qfIdx]) ? "moveInR" : null
          );
        }

        /* Right side: sf index 1 */
        renderMatch(
          elStage,
          X.right.sf,
          qfOutR[0], qfOutR[1],
          br.sf.a[1], br.sf.b[1],
          st.winners.sf[1],
          st.times && st.times.sf ? st.times.sf[1] : "",
          true,
          30,
          (anim && anim.sfA[1]) ? "moveInR" : null,
          (anim && anim.sfB[1]) ? "moveInR" : null
        );

        /* Final: side-by-side at center */
        var xCenterFinal = X.final + Math.floor(CFG.COL_W/2);
        renderFinalSideBySide(
          elStage,
          xCenterFinal,
          finalOut,
          br.f.a[0], br.f.b[0],
          st.winners.f[0],
          st.times && st.times.f ? st.times.f[0] : "",
          40,
          (anim && anim.fA) ? "moveInL" : null,
          (anim && anim.fB) ? "moveInR" : null
        );

        elUpdated.innerHTML = st.updated_at ? ("Sist oppdatert: " + st.updated_at) : "—";

        lastBracket = br;
      }

      function tick(){
        xhrGet(CFG.API_GET, function(ok, res){
          if (!ok || !res || !res.ok) return;
          var st = safeState(res.state);

          if (st.updated_at && st.updated_at === lastUpdated) return;

          lastUpdated = st.updated_at || ("" + new Date().getTime());
          lastState = st;
          render(st, false);
        });
      }

      function onResize(){
        if (!lastState) return;
        render(lastState, true);
      }

      tick();
      setInterval(tick, CFG.POLL_MS);

      if (window.addEventListener) window.addEventListener("resize", onResize, false);
      else if (window.attachEvent) window.attachEvent("onresize", onResize);
    })();
  </script>
</body>
</html>
