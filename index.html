<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Turnering – Kontroll</title>
  <style>
    body{
      margin:0;
      font-family: Arial, sans-serif;
      background:#0b0b0d;
      color:#f4f4f6;
    }
    .wrap{
      max-width:1500px;
      margin:0 auto;
      padding:18px;
    }
    .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:12px;
    }
    h1{
      margin:0;
      font-size:34px;
      line-height:1.1;
      letter-spacing:.2px;
    }
    .btn{
      display:inline-block;
      background:#d61f26;
      color:#fff;
      text-decoration:none;
      padding:12px 16px;
      border-radius:12px;
      font-weight:800;
      font-size:18px;
      border:0;
      cursor:pointer;
    }
    .btn.secondary{
      background:#1b1b1f;
      border:2px solid rgba(214,31,38,.55);
      padding:10px 14px;
    }
    .grid{
      display:flex;
      gap:16px;
      flex-wrap:wrap;
      align-items:flex-start;
    }
    .card{
      background:#121216;
      border:2px solid rgba(214,31,38,.35);
      border-radius:16px;
      box-shadow:0 18px 50px rgba(0,0,0,.45);
      padding:14px;
      flex:1 1 560px;
      min-width:340px;
    }
    .card h2{
      margin:0 0 10px 0;
      font-size:24px;
    }
    #status{
      margin:10px 0 14px 0;
      padding:10px 12px;
      border-radius:12px;
      background:#121216;
      border:2px solid rgba(214,31,38,.25);
      font-size:18px;
      min-height:22px;
      color:#f4f4f6;
    }

    .players{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .pRow{
      width:calc(50% - 5px);
      min-width:220px;
      display:flex;
      align-items:center;
      gap:8px;
      margin-bottom:8px;
    }
    .pRow label{
      width:46px;
      font-weight:800;
      font-size:18px;
      color:rgba(244,244,246,.72);
    }
    .pRow input{
      flex:1;
      font-size:18px;
      padding:10px 10px;
      border-radius:12px;
      border:2px solid rgba(214,31,38,.25);
      outline:none;
      background:#0f0f12;
      color:#f4f4f6;
    }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }

    .roundTitle{
      font-size:22px;
      font-weight:900;
      margin:14px 0 8px 0;
      color:#fff;
    }

    .matchRow{
      display:flex;
      align-items:stretch;
      gap:10px;
      flex-wrap:wrap;
      padding:10px;
      border-radius:14px;
      border:2px solid rgba(214,31,38,.22);
      background:#0f0f12;
      margin-bottom:10px;
    }
    .matchLabel{
      width:92px;
      font-weight:900;
      font-size:18px;
      color:rgba(244,244,246,.72);
      display:flex;
      align-items:center;
    }

    .timeBox{
      width:220px;
      max-width:100%;
      border-radius:12px;
      border:2px solid rgba(214,31,38,.22);
      background:#0b0b0d;
      color:#f4f4f6;
      font-size:16px;
      padding:10px 10px;
      outline:none;
    }

    .pickBtn{
      border:2px solid rgba(214,31,38,.22);
      background:#121216;
      border-radius:14px;
      padding:10px 12px;
      font-size:20px;
      font-weight:900;
      cursor:pointer;
      min-width:260px;
      text-align:left;
      color:#f4f4f6;
    }
    .pickBtn.disabled{
      opacity:.45;
      cursor:default;
    }
    .pickBtn.winner{
      border-color:rgba(214,31,38,.9);
      box-shadow:0 0 0 4px rgba(214,31,38,.18) inset;
      background:#0b0b0d;
    }

    .miniBtn{
      border:2px solid rgba(214,31,38,.22);
      background:#121216;
      border-radius:12px;
      padding:10px 12px;
      font-size:18px;
      font-weight:900;
      cursor:pointer;
      color:#f4f4f6;
    }
    .miniBtn.danger{
      border-color:rgba(214,31,38,.75);
      background:#0b0b0d;
    }

    .note{
      color:rgba(244,244,246,.68);
      font-size:16px;
      margin-top:6px;
      line-height:1.35;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <h1>Turnering – kontroll</h1>
      <div style="display:flex;gap:10px;flex-wrap:wrap;">
        <a class="btn secondary" href="display.html" target="_blank">Åpne display</a>
      </div>
    </div>

    <div id="status"></div>

    <div class="grid">
      <div class="card">
        <h2>Deltakere (16)</h2>
        <div id="players" class="players"></div>
        <div class="actions">
          <button id="btnSavePlayers" class="btn">Lagre spillere (nullstiller vinnere)</button>
          <button id="btnReload" class="btn secondary">Oppdater fra DB</button>
        </div>
        <div class="note">Rekkefølge bestemmer matchups: 1 vs 2, 3 vs 4, …, 15 vs 16.</div>
      </div>

      <div class="card">
        <h2>Kamper</h2>
        <div id="matches"></div>
        <div class="note">Dato/tid lagres per kamp og vises på display rett over matchupen.</div>
      </div>
    </div>
  </div>

  <script>
    (function(){
      var API = {
        get: "/.netlify/functions/get-bracket",
        savePlayers: "/.netlify/functions/save-players",
        setWinner: "/.netlify/functions/set-winner",
        clearWinner: "/.netlify/functions/clear-winner",
        setMatchTime: "/.netlify/functions/set-matchtime"
      };

      var els = {
        status: document.getElementById("status"),
        players: document.getElementById("players"),
        matches: document.getElementById("matches"),
        btnSavePlayers: document.getElementById("btnSavePlayers"),
        btnReload: document.getElementById("btnReload")
      };

      var state = null;

      function sTrim(s){
        return (s || "").replace(/^\s+|\s+$/g, "");
      }

      function setStatus(msg){
        els.status.innerHTML = msg || "";
      }

      function xhr(method, url, data, cb){
        var x = new XMLHttpRequest();
        x.onreadystatechange = function(){
          if (x.readyState !== 4) return;
          var ok = (x.status >= 200 && x.status < 300);
          var res = null;
          try { res = JSON.parse(x.responseText || "{}"); } catch(e){ res = {}; }
          cb(ok, res, x);
        };
        x.open(method, url, true);
        if (method === "POST" || method === "PUT") {
          x.setRequestHeader("Content-Type", "application/json;charset=utf-8");
        }
        x.send(data ? JSON.stringify(data) : null);
      }

      function blankState(){
        var i, p = [];
        for (i=0;i<16;i++) p.push("");
        return {
          players: p,
          winners: {
            r16: [null,null,null,null,null,null,null,null],
            qf: [null,null,null,null],
            sf: [null,null],
            f: [null]
          },
          times: {
            r16: ["","","","","","","",""],
            qf:  ["","","",""],
            sf:  ["",""],
            f:   [""]
          },
          updated_at: null
        };
      }

      function safeState(raw){
        var st = blankState();
        if (!raw) return st;

        if (raw.players && raw.players.length === 16) st.players = raw.players;

        if (raw.winners) {
          st.winners.r16 = (raw.winners.r16 && raw.winners.r16.length === 8) ? raw.winners.r16 : st.winners.r16;
          st.winners.qf  = (raw.winners.qf  && raw.winners.qf.length  === 4) ? raw.winners.qf  : st.winners.qf;
          st.winners.sf  = (raw.winners.sf  && raw.winners.sf.length  === 2) ? raw.winners.sf  : st.winners.sf;
          st.winners.f   = (raw.winners.f   && raw.winners.f.length   === 1) ? raw.winners.f   : st.winners.f;
        }

        if (raw.times) {
          st.times.r16 = (raw.times.r16 && raw.times.r16.length === 8) ? raw.times.r16 : st.times.r16;
          st.times.qf  = (raw.times.qf  && raw.times.qf.length  === 4) ? raw.times.qf  : st.times.qf;
          st.times.sf  = (raw.times.sf  && raw.times.sf.length  === 2) ? raw.times.sf  : st.times.sf;
          st.times.f   = (raw.times.f   && raw.times.f.length   === 1) ? raw.times.f   : st.times.f;
        }

        st.updated_at = raw.updated_at || null;
        return st;
      }

      function computeBracket(st){
        var out = {
          r16: { a:[], b:[], w:[], wn:[] },
          qf:  { a:[], b:[], w:[], wn:[] },
          sf:  { a:[], b:[], w:[], wn:[] },
          f:   { a:[], b:[], w:[], wn:[] },
          champ: ""
        };

        var i, a, b, w;

        for (i=0;i<8;i++){
          a = sTrim(st.players[i*2] || "");
          b = sTrim(st.players[i*2+1] || "");
          out.r16.a[i]=a; out.r16.b[i]=b;
          w = st.winners.r16[i];
          out.r16.w[i]=w;
          out.r16.wn[i] = (w===0) ? a : ((w===1) ? b : "");
        }

        for (i=0;i<4;i++){
          a = out.r16.wn[i*2] || "";
          b = out.r16.wn[i*2+1] || "";
          out.qf.a[i]=a; out.qf.b[i]=b;
          w = st.winners.qf[i];
          out.qf.w[i]=w;
          out.qf.wn[i] = (w===0) ? a : ((w===1) ? b : "");
        }

        for (i=0;i<2;i++){
          a = out.qf.wn[i*2] || "";
          b = out.qf.wn[i*2+1] || "";
          out.sf.a[i]=a; out.sf.b[i]=b;
          w = st.winners.sf[i];
          out.sf.w[i]=w;
          out.sf.wn[i] = (w===0) ? a : ((w===1) ? b : "");
        }

        a = out.sf.wn[0] || "";
        b = out.sf.wn[1] || "";
        out.f.a[0]=a; out.f.b[0]=b;
        w = st.winners.f[0];
        out.f.w[0]=w;
        out.f.wn[0] = (w===0) ? a : ((w===1) ? b : "");

        out.champ = out.f.wn[0] || "";
        return out;
      }

      function esc(s){
        s = s || "";
        return s
          .replace(/&/g,"&amp;")
          .replace(/</g,"&lt;")
          .replace(/>/g,"&gt;")
          .replace(/"/g,"&quot;")
          .replace(/'/g,"&#039;");
      }

      function renderPlayers(st){
        var html = "";
        var i, val;
        for (i=0;i<16;i++){
          val = sTrim(st.players[i] || "");
          html += '<div class="pRow">';
          html += '<label>' + (i+1) + '.</label>';
          html += '<input id="p' + i + '" type="text" value="' + esc(val) + '" />';
          html += '</div>';
        }
        els.players.innerHTML = html;
      }

      function renderRound(title, roundKey, count, br){
        var i;
        var html = '<div class="roundTitle">' + title + '</div>';

        for (i=0;i<count;i++){
          var a = br[roundKey].a[i] || "";
          var b = br[roundKey].b[i] || "";
          var w = state.winners[roundKey][i];
          var t = (state.times && state.times[roundKey]) ? (state.times[roundKey][i] || "") : "";

          var canPick = (sTrim(a) !== "" && sTrim(b) !== "");
          var dis = canPick ? "" : " disabled";

          var aCls = "pickBtn" + (canPick ? "" : " disabled") + ((w===0) ? " winner" : "");
          var bCls = "pickBtn" + (canPick ? "" : " disabled") + ((w===1) ? " winner" : "");

          html += '<div class="matchRow">';
          html +=   '<div class="matchLabel">Match ' + (i+1) + '</div>';
          html +=   '<input class="timeBox" type="text" placeholder="Dato/tid" value="' + esc(t) + '" data-round="' + roundKey + '" data-match="' + i + '" />';
          html +=   '<button class="' + aCls + '" data-round="' + roundKey + '" data-match="' + i + '" data-win="0"' + dis + '>' + esc(a || "—") + '</button>';
          html +=   '<button class="' + bCls + '" data-round="' + roundKey + '" data-match="' + i + '" data-win="1"' + dis + '>' + esc(b || "—") + '</button>';
          html +=   '<button class="miniBtn danger" data-round="' + roundKey + '" data-match="' + i + '" data-clear="1"' + (w===null ? " disabled" : "") + '>Tøm</button>';
          html += '</div>';
        }

        return html;
      }

      function renderMatches(st){
        var br = computeBracket(st);

        var html = "";
        html += renderRound("Åttendedelsfinaler (16 → 8)", "r16", 8, br);
        html += renderRound("Kvartfinaler (8 → 4)", "qf", 4, br);
        html += renderRound("Semifinaler (4 → 2)", "sf", 2, br);
        html += renderRound("Finale (2 → 1)", "f", 1, br);

        els.matches.innerHTML = html;

        attachHandlers();
      }

      function attachHandlers(){
        var buttons = els.matches.getElementsByTagName("button");
        var i;
        for (i=0;i<buttons.length;i++){
          buttons[i].onclick = onMatchClick;
        }

        var inputs = els.matches.getElementsByTagName("input");
        for (i=0;i<inputs.length;i++){
          if (inputs[i].className && inputs[i].className.indexOf("timeBox") !== -1) {
            inputs[i].onblur = onTimeBlur;
          }
        }
      }

      function onMatchClick(ev){
        var t = ev ? (ev.target || ev.srcElement) : null;
        if (!t) return;
        if (t.disabled) return;

        var round = t.getAttribute("data-round");
        var match = parseInt(t.getAttribute("data-match"), 10);

        if (t.getAttribute("data-clear") === "1") {
          clearWinner(round, match);
          return;
        }

        var win = parseInt(t.getAttribute("data-win"), 10);
        setWinner(round, match, win);
      }

      function onTimeBlur(ev){
        var t = ev ? (ev.target || ev.srcElement) : null;
        if (!t) return;
        var round = t.getAttribute("data-round");
        var match = parseInt(t.getAttribute("data-match"), 10);
        var val = sTrim(t.value || "");
        setMatchTime(round, match, val);
      }

      function load(){
        setStatus("Laster …");
        xhr("GET", API.get, null, function(ok, res){
          if (!ok || !res || !res.ok) {
            setStatus("Feil: Klarte ikke å hente data fra DB.");
            state = blankState();
            renderPlayers(state);
            renderMatches(state);
            return;
          }
          state = safeState(res.state);
          setStatus("Sist oppdatert: " + (state.updated_at || "—"));
          renderPlayers(state);
          renderMatches(state);
        });
      }

      function savePlayers(){
        var p = [];
        var i, v;
        for (i=0;i<16;i++){
          v = document.getElementById("p"+i).value;
          p.push(sTrim(v));
        }

        xhr("POST", API.savePlayers, { players: p }, function(ok, res){
          if (!ok || !res || !res.ok) {
            setStatus("Feil: Kunne ikke lagre spillere.");
            return;
          }
          setStatus("Lagret. Sist oppdatert: " + (res.updated_at || "—"));
          load();
        });
      }

      function setWinner(round, match, winner){
        xhr("POST", API.setWinner, { round: round, match: match, winner: winner }, function(ok, res){
          if (!ok || !res || !res.ok) {
            setStatus("Feil: Kunne ikke sette vinner. Fyll inn begge navnene i matchen først.");
            return;
          }
          setStatus("Oppdatert. Sist oppdatert: " + (res.updated_at || "—"));
          load();
        });
      }

      function clearWinner(round, match){
        xhr("POST", API.clearWinner, { round: round, match: match }, function(ok, res){
          if (!ok || !res || !res.ok) {
            setStatus("Feil: Kunne ikke tømme vinner.");
            return;
          }
          setStatus("Oppdatert. Sist oppdatert: " + (res.updated_at || "—"));
          load();
        });
      }

      function setMatchTime(round, match, timeStr){
        xhr("POST", API.setMatchTime, { round: round, match: match, time: timeStr }, function(ok, res){
          if (!ok || !res || !res.ok) {
            setStatus("Feil: Kunne ikke lagre dato/tid.");
            return;
          }
          setStatus("Oppdatert. Sist oppdatert: " + (res.updated_at || "—"));
          load();
        });
      }

      els.btnSavePlayers.onclick = function(){ savePlayers(); };
      els.btnReload.onclick = function(){ load(); };

      load();
    })();
  </script>
</body>
</html>
